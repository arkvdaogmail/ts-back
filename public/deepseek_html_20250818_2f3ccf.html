<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Login with Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Keep all your existing CSS styles] */
        /* They are perfect, no changes needed */
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->
    <!-- It's well designed, we'll just make the auth work -->

    <script>
        // 1. Initialize Supabase (replace with your actual credentials)
        const supabaseUrl = 'https://YOUR-PROJECT-REF.supabase.co';
        const supabaseKey = 'YOUR-SUPABASE-KEY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 2. DOM Elements
        const githubLoginBtn = document.getElementById('githubLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBox = document.getElementById('loginBox');
        const userInfo = document.getElementById('userInfo');
        const statusMessage = document.getElementById('statusMessage');
        const userAvatar = document.getElementById('userAvatar');
        const usernameEl = document.getElementById('username');
        const userEmailEl = document.getElementById('userEmail');
        const publicReposEl = document.getElementById('publicRepos');
        const followersEl = document.getElementById('followers');
        const followingEl = document.getElementById('following');

        // 3. GitHub Login Function
        async function signInWithGitHub() {
            try {
                showStatus('Redirecting to GitHub...', 'loading');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: window.location.href
                    }
                });

                if (error) throw error;
                
            } catch (error) {
                console.error('Login error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // 4. Logout Function
        async function signOut() {
            try {
                showStatus('Signing out...', 'loading');
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Update UI
                userInfo.style.display = 'none';
                loginBox.style.display = 'block';
                
                showStatus('Successfully signed out', 'success');
                setTimeout(() => statusMessage.textContent = '', 3000);
                
            } catch (error) {
                console.error('Logout error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // 5. Fetch GitHub User Data
        async function fetchGitHubUserData(accessToken) {
            try {
                showStatus('Fetching GitHub data...', 'loading');
                
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) throw new Error('GitHub API request failed');
                return await response.json();
                
            } catch (error) {
                console.error('GitHub API error:', error);
                showStatus(`Error fetching GitHub data: ${error.message}`, 'error');
                return null;
            }
        }

        // 6. Check Auth State
        async function checkAuthState() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) throw error;
                
                if (session) {
                    // User is logged in
                    loginBox.style.display = 'none';
                    userInfo.style.display = 'block';
                    
                    // Get user info
                    const user = session.user;
                    usernameEl.textContent = user.user_metadata.full_name || user.email;
                    userEmailEl.textContent = user.email;
                    
                    // Set avatar
                    if (user.user_metadata.avatar_url) {
                        userAvatar.style.backgroundImage = `url(${user.user_metadata.avatar_url})`;
                    }
                    
                    // Get GitHub access token and fetch additional data
                    const { data } = await supabase.auth.getSession();
                    if (data.session?.provider_token) {
                        const githubData = await fetchGitHubUserData(data.session.provider_token);
                        if (githubData) {
                            publicReposEl.textContent = githubData.public_repos || 0;
                            followersEl.textContent = githubData.followers || 0;
                            followingEl.textContent = githubData.following || 0;
                            showStatus('GitHub data loaded!', 'success');
                        }
                    }
                } else {
                    // User is not logged in
                    loginBox.style.display = 'block';
                    userInfo.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Auth state error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Helper function to show status messages
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
        }

        // Event Listeners
        githubLoginBtn.addEventListener('click', signInWithGitHub);
        logoutBtn.addEventListener('click', signOut);

        // Initialize
        document.addEventListener('DOMContentLoaded', checkAuthState);
        
        // Handle auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuthState();
            }
        });
    </script>
</body>
</html>